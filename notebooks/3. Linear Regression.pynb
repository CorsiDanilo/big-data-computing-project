{"cells":[{"cell_type":"markdown","metadata":{"id":"e452Ydj7chNV"},"source":["# **Bitcoin price forecasting - LinearRegression**\n","### Big Data Computing final project - A.Y. 2022 - 2023\n","Prof. Gabriele Tolomei\n","\n","MSc in Computer Science\n","\n","La Sapienza, University of Rome\n","\n","### Author\n","Corsi Danilo - corsi.1742375@studenti.uniroma1.it\n","\n"]},{"cell_type":"markdown","metadata":{"id":"IXTGTgzEqE3x"},"source":["# Dependencies, Libraries and Tools"]},{"cell_type":"code","execution_count":1,"metadata":{"id":"KBBl4_PN9b-_","executionInfo":{"status":"ok","timestamp":1692034157851,"user_tz":-120,"elapsed":22,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["JAVA_HOME = \"/usr/lib/jvm/java-8-openjdk-amd64\"\n","MODEL_NAME = \"LinearRegression\"\n","SLOW_OPERATION = False"]},{"cell_type":"code","execution_count":2,"metadata":{"id":"KtybX1UoxOZT","executionInfo":{"status":"ok","timestamp":1692034157853,"user_tz":-120,"elapsed":18,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["import warnings\n","\n","warnings.simplefilter(action='ignore', category=FutureWarning)"]},{"cell_type":"code","execution_count":3,"metadata":{"id":"PX7xDYw4SvrB","executionInfo":{"status":"ok","timestamp":1692034159553,"user_tz":-120,"elapsed":1717,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["#Install some useful dependencies\n","import requests\n","import pandas as pd\n","import numpy as np\n","import matplotlib.pyplot as plt\n","import seaborn as sns\n","%matplotlib inline\n","\n","from itertools import cycle\n","\n","import plotly.express as px\n","\n","import plotly.graph_objs as go\n","from plotly.offline import init_notebook_mode, iplot\n","import gc\n","\n","import pandas as pd\n","import numpy as np\n","import json\n","\n","import matplotlib.pyplot as plt\n","import seaborn as sns\n","\n","# !pip install -U -q PyDrive # To use files that are stored in Google Drive directly (e.g., without downloading them from an external URL)\n","# !apt install openjdk-8-jdk-headless -qq\n","# import os\n","# os.environ[\"JAVA_HOME\"] = JAVA_HOME"]},{"cell_type":"code","execution_count":4,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Si82CaUYSvrA","outputId":"c5600628-dd76-47cc-9f05-a46e96108dae","executionInfo":{"status":"ok","timestamp":1692034208744,"user_tz":-120,"elapsed":49226,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting pyspark\n","  Downloading pyspark-3.4.1.tar.gz (310.8 MB)\n","\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m310.8/310.8 MB\u001b[0m \u001b[31m2.7 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25h  Preparing metadata (setup.py) ... \u001b[?25l\u001b[?25hdone\n","Requirement already satisfied: py4j==0.10.9.7 in /usr/local/lib/python3.10/dist-packages (from pyspark) (0.10.9.7)\n","Building wheels for collected packages: pyspark\n","  Building wheel for pyspark (setup.py) ... \u001b[?25l\u001b[?25hdone\n","  Created wheel for pyspark: filename=pyspark-3.4.1-py2.py3-none-any.whl size=311285388 sha256=36865425c9bcd35b7830520d3209791ac5b482fa4e4ddf7b485ba83750d65574\n","  Stored in directory: /root/.cache/pip/wheels/0d/77/a3/ff2f74cc9ab41f8f594dabf0579c2a7c6de920d584206e0834\n","Successfully built pyspark\n","Installing collected packages: pyspark\n","Successfully installed pyspark-3.4.1\n"]}],"source":["# Install Spark and related dependencies\n","!pip install pyspark\n","\n","import pyspark\n","from pyspark.sql import *\n","from pyspark.sql.types import *\n","from pyspark.sql.functions import *\n","from pyspark import SparkContext, SparkConf\n","\n","from pyspark.ml.regression import LinearRegression, RandomForestRegressor, GBTRegressor\n","from pyspark.ml.tuning import CrossValidator, ParamGridBuilder\n","from pyspark.ml.evaluation import RegressionEvaluator\n","from pyspark.ml.feature import VectorAssembler\n","from pyspark.ml.stat import Correlation\n","from pyspark.ml import Pipeline\n","\n","# Create the session\n","conf = SparkConf().\\\n","                set('spark.ui.port', \"4050\").\\\n","                set('spark.executor.memory', '4G').\\\n","                set('spark.driver.memory', '45G').\\\n","                set('spark.driver.maxResultSize', '10G').\\\n","                set(\"spark.kryoserializer.buffer.max\", \"1G\").\\\n","                setAppName(\"BitcoinPriceForecasting\").\\\n","                setMaster(\"local[*]\")\n","\n","# Create the context\n","sc = pyspark.SparkContext(conf=conf)\n","spark = SparkSession.builder.getOrCreate()"]},{"cell_type":"markdown","metadata":{"id":"AzbZ43th9HTt"},"source":["# Link to Google Drive"]},{"cell_type":"code","execution_count":5,"metadata":{"id":"ta3R-fAY9J6l","executionInfo":{"status":"ok","timestamp":1692034208745,"user_tz":-120,"elapsed":15,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Define GDrive paths\n","GDRIVE_DIR = \"/content/drive\"\n","\n","GDRIVE_DATASET_OUTPUT_DIR = GDRIVE_DIR + \"/MyDrive/BDC/project/datasets/output\"\n","\n","GDRIVE_DATASET_NAME = \"bitcoin_blockchain_data_30min\"\n","GDRIVE_DATASET_NAME_ENG = GDRIVE_DATASET_NAME + \"_eng\"\n","\n","GDRIVE_DATASET_NAME_EXT_ENG  = \"/\" + GDRIVE_DATASET_NAME_ENG + \".parquet\"\n","\n","GDRIVE_DATASET_NAME_ENG = GDRIVE_DATASET_OUTPUT_DIR + GDRIVE_DATASET_NAME_EXT_ENG\n"]},{"cell_type":"code","execution_count":6,"metadata":{"id":"au2-MqC-SvrB","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1692034421575,"user_tz":-120,"elapsed":212842,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"d59b5b53-0582-4bba-e3c4-e2a754c66143"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["# Point Colaboratory to our Google Drive\n","from google.colab import drive\n","\n","drive.mount(GDRIVE_DIR, force_remount=True)"]},{"cell_type":"code","execution_count":7,"metadata":{"id":"yiF49OXz4-i7","executionInfo":{"status":"ok","timestamp":1692034434686,"user_tz":-120,"elapsed":13123,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Load datasets into pyspark dataframe objects\n","df = spark.read.load(GDRIVE_DATASET_NAME_ENG,\n","                         format=\"parquet\",\n","                         sep=\",\",\n","                         inferSchema=\"true\",\n","                         header=\"true\"\n","                    )"]},{"cell_type":"markdown","metadata":{"id":"AUXPeznPiPVm"},"source":["# Import my utilities"]},{"cell_type":"code","execution_count":8,"metadata":{"id":"l6HkFYXMU9Z_","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1692034436864,"user_tz":-120,"elapsed":2197,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"348046e3-e1ad-4812-af5c-ba250d42b424"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["<module 'utilities' from '/content/drive/MyDrive/BDC/project/utilities/utilities.py'>"]},"metadata":{},"execution_count":8}],"source":["import sys\n","GDRIVE_UTILITIES_DIR = GDRIVE_DIR + \"/MyDrive/BDC/project/utilities\"\n","sys.path.append(GDRIVE_UTILITIES_DIR)\n","\n","import shutil\n","shutil.rmtree(GDRIVE_UTILITIES_DIR + '/__pycache__')\n","\n","import utilities\n","\n","import importlib\n","importlib.reload(utilities)"]},{"cell_type":"markdown","metadata":{"id":"f0yi3Fcth9fi"},"source":["# Evaluation of a simple model"]},{"cell_type":"code","execution_count":9,"metadata":{"id":"mW9l9S1cRAPQ","executionInfo":{"status":"ok","timestamp":1692034436865,"user_tz":-120,"elapsed":8,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["GDRIVE_FEATURES_DIR = GDRIVE_DIR + \"/MyDrive/BDC/project/features\"\n","\n","GDRIVE_ALL_FEATURES_NAME = \"all_features\"\n","GDRIVE_COR_MATRIX_FEATURES_NAME = \"cm_features\"\n","\n","GDRIVE_ALL_FEATURES_NAME_EXT = \"/\" + GDRIVE_ALL_FEATURES_NAME + \".json\"\n","GDRIVE_COR_MATRIX_FEATURES_NAME_EXT = \"/\" + GDRIVE_COR_MATRIX_FEATURES_NAME + \".json\"\n","\n","GDRIVE_ALL_FEATURES = GDRIVE_FEATURES_DIR + GDRIVE_ALL_FEATURES_NAME_EXT\n","GDRIVE_COR_MATRIX_FEATURES = GDRIVE_FEATURES_DIR + GDRIVE_COR_MATRIX_FEATURES_NAME_EXT"]},{"cell_type":"code","execution_count":10,"metadata":{"id":"We-f-26Byi2R","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1692034440166,"user_tz":-120,"elapsed":3308,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"139156b2-2586-48b1-e6c7-4bfd48deb249"},"outputs":[{"output_type":"stream","name":"stdout","text":["['total-bitcoins', 'market-cap', 'trade-volume', 'blocks-size', 'avg-block-size', 'n-transactions-total', 'n-transactions-per-block', 'hash-rate', 'difficulty', 'miners-revenue', 'transaction-fees-usd', 'n-unique-addresses', 'n-transactions', 'estimated-transaction-volume-usd']\n","['market-cap', 'miners-revenue', 'estimated-transaction-volume-usd', 'n-transactions-total', 'blocks-size', 'total-bitcoins', 'difficulty']\n"]}],"source":["# Loading all features\n","with open(GDRIVE_ALL_FEATURES, \"r\") as f:\n","    all_features = json.load(f)\n","print(all_features)\n","\n","# Loading correlation matrix features\n","with open(GDRIVE_COR_MATRIX_FEATURES, \"r\") as f:\n","    cm_features = json.load(f)\n","print(cm_features)\n","\n","# Set the depended variable\n","TARGET_VAL = 'tomorrow-market-price'\n","\n","# Set the features label\n","FEATURES_LABEL = \"features\""]},{"cell_type":"code","execution_count":11,"metadata":{"id":"A1mwZi3i_YNg","colab":{"base_uri":"https://localhost:8080/","height":594,"output_embedded_package_id":"1xwhR7roDxUALTkwZfdaoPrdKgjLwAnHo"},"executionInfo":{"status":"ok","timestamp":1692034477288,"user_tz":-120,"elapsed":37133,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"550b4d47-4774-49b1-aae9-c38ebd90c4eb"},"outputs":[{"output_type":"display_data","data":{"text/plain":"Output hidden; open in https://colab.research.google.com to view."},"metadata":{}}],"source":["# Valid performances with all the features\n","utilities.evaluate_simple_model(df, all_features, MODEL_NAME, FEATURES_LABEL, TARGET_VAL)"]},{"cell_type":"code","execution_count":12,"metadata":{"id":"x9ezKKJCALN3","colab":{"base_uri":"https://localhost:8080/","height":594,"output_embedded_package_id":"18UJoBLEUAtdyL46KVR1aX6uj2kEdoVhi"},"executionInfo":{"status":"ok","timestamp":1692034491803,"user_tz":-120,"elapsed":14528,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"ccaf6699-5261-410a-ce7d-01b5a428877f"},"outputs":[{"output_type":"display_data","data":{"text/plain":"Output hidden; open in https://colab.research.google.com to view."},"metadata":{}}],"source":["# Valid performances with the corr matrix features\n","utilities.evaluate_simple_model(df, cm_features, MODEL_NAME, FEATURES_LABEL, TARGET_VAL)"]},{"cell_type":"markdown","metadata":{"id":"VtMWbkfK_2IC"},"source":["# Hyperparameter tuning w/ Time-series cross validation"]},{"cell_type":"code","execution_count":13,"metadata":{"id":"pdyj7fNqDHjO","executionInfo":{"status":"ok","timestamp":1692034491804,"user_tz":-120,"elapsed":32,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Split proportion list\n","PORTION_LIST = [0.6, 0.7, 0.8, 0.9]"]},{"cell_type":"code","execution_count":14,"metadata":{"id":"a0l41YAgoG6p","executionInfo":{"status":"ok","timestamp":1692034491804,"user_tz":-120,"elapsed":31,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Linear Regression params\n","# params = {\n","#     'maxIter' : [5, 10, 50, 80, 100], # max number of iterations (>=0), default:100\n","#     'regParam' : np.arange(0,1,0.2).round(decimals=2),# regularization parameter (>=0), default:0.0\n","#     'elasticNetParam' : np.arange(0,1,0.2).round(decimals=2) # the ElasticNet mixing parameter, [0, 1], default:0.0\n","# }\n","\n","params = {\n","    'maxIter' : [5, 10, 50, 80, 100], # max number of iterations (>=0), default:100\n","    'regParam' : np.arange(0,1,0.2).round(decimals=2),# regularization parameter (>=0), default:0.0\n","    'elasticNetParam' : np.arange(0,1,0.2).round(decimals=2) # the ElasticNet mixing parameter, [0, 1], default:0.0\n","}"]},{"cell_type":"code","execution_count":15,"metadata":{"id":"cGjP3Evgwh1y","colab":{"base_uri":"https://localhost:8080/","height":142},"executionInfo":{"status":"ok","timestamp":1692034971552,"user_tz":-120,"elapsed":479778,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"cdb59dbb-f570-48e3-e8d3-b5f0a01c89bb"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["              Model  Proportion     Parameters        RMSE      MAPE  \\\n","0  LinearRegression         0.9  [5, 0.0, 0.0]  430.836224  0.014122   \n","\n","          MAE      Variance        R2  Adjusted_R2      Time  \\\n","0  287.836999  6.228715e+06  0.968863     0.968851  0.992755   \n","\n","                                         Predictions  \n","0  DataFrame[tomorrow-market-price: double, predi...  "],"text/html":["\n","\n","  <div id=\"df-149eee01-8ddb-40d5-83b1-e192d4d95305\">\n","    <div class=\"colab-df-container\">\n","      <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Model</th>\n","      <th>Proportion</th>\n","      <th>Parameters</th>\n","      <th>RMSE</th>\n","      <th>MAPE</th>\n","      <th>MAE</th>\n","      <th>Variance</th>\n","      <th>R2</th>\n","      <th>Adjusted_R2</th>\n","      <th>Time</th>\n","      <th>Predictions</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>LinearRegression</td>\n","      <td>0.9</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>430.836224</td>\n","      <td>0.014122</td>\n","      <td>287.836999</td>\n","      <td>6.228715e+06</td>\n","      <td>0.968863</td>\n","      <td>0.968851</td>\n","      <td>0.992755</td>\n","      <td>DataFrame[tomorrow-market-price: double, predi...</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-149eee01-8ddb-40d5-83b1-e192d4d95305')\"\n","              title=\"Convert this dataframe to an interactive table.\"\n","              style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","       width=\"24px\">\n","    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n","    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n","  </svg>\n","      </button>\n","\n","\n","\n","    <div id=\"df-ac082deb-355a-41de-8d18-a09cf1976b14\">\n","      <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-ac082deb-355a-41de-8d18-a09cf1976b14')\"\n","              title=\"Suggest charts.\"\n","              style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","      </button>\n","    </div>\n","\n","<style>\n","  .colab-df-quickchart {\n","    background-color: #E8F0FE;\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: #1967D2;\n","    height: 32px;\n","    padding: 0 0 0 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: #E2EBFA;\n","    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: #174EA6;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","    background-color: #3B4455;\n","    fill: #D2E3FC;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart:hover {\n","    background-color: #434B5C;\n","    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","    fill: #FFFFFF;\n","  }\n","</style>\n","\n","    <script>\n","      async function quickchart(key) {\n","        const containerElement = document.querySelector('#' + key);\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      }\n","    </script>\n","\n","      <script>\n","\n","function displayQuickchartButton(domScope) {\n","  let quickchartButtonEl =\n","    domScope.querySelector('#df-ac082deb-355a-41de-8d18-a09cf1976b14 button.colab-df-quickchart');\n","  quickchartButtonEl.style.display =\n","    google.colab.kernel.accessAllowed ? 'block' : 'none';\n","}\n","\n","        displayQuickchartButton(document);\n","      </script>\n","      <style>\n","    .colab-df-container {\n","      display:flex;\n","      flex-wrap:wrap;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","      <script>\n","        const buttonEl =\n","          document.querySelector('#df-149eee01-8ddb-40d5-83b1-e192d4d95305 button.colab-df-convert');\n","        buttonEl.style.display =\n","          google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","        async function convertToInteractive(key) {\n","          const element = document.querySelector('#df-149eee01-8ddb-40d5-83b1-e192d4d95305');\n","          const dataTable =\n","            await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                     [key], {});\n","          if (!dataTable) return;\n","\n","          const docLinkHtml = 'Like what you see? Visit the ' +\n","            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","            + ' to learn more about interactive tables.';\n","          element.innerHTML = '';\n","          dataTable['output_type'] = 'display_data';\n","          await google.colab.output.renderOutput(dataTable, element);\n","          const docLink = document.createElement('div');\n","          docLink.innerHTML = docLinkHtml;\n","          element.appendChild(docLink);\n","        }\n","      </script>\n","    </div>\n","  </div>\n"]},"metadata":{},"execution_count":15}],"source":["results = utilities.autoTuning(df, cm_features, params, PORTION_LIST, MODEL_NAME, FEATURES_LABEL, TARGET_VAL)\n","results"]},{"cell_type":"code","execution_count":25,"metadata":{"id":"A4PvIcZSoByq","executionInfo":{"status":"ok","timestamp":1692035170708,"user_tz":-120,"elapsed":4,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Linear Regression params\n","params = {\n","    'maxIter' : [5], # max number of iterations (>=0), default:100\n","    'regParam' : [0.0],# regularization parameter (>=0), default:0.0\n","    'elasticNetParam' : [0.0] # the ElasticNet mixing parameter, [0, 1], default:0.0\n","}"]},{"cell_type":"code","execution_count":26,"metadata":{"id":"NGVFqofRIB5K","executionInfo":{"status":"ok","timestamp":1692035172641,"user_tz":-120,"elapsed":4,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["## Cross Validation Parameter\n","# Multiple Splits Time Series Cross Validation\n","mul_cv = {'cv_type':'mulTs',\n","          'kSplits': 5}\n","\n","# Blocked Time Series Cross Validation\n","blk_cv = {'cv_type':'blkTs',\n","          'kSplits': 10}"]},{"cell_type":"code","execution_count":27,"metadata":{"id":"HwenQ5gvlR8q","colab":{"base_uri":"https://localhost:8080/","height":206},"executionInfo":{"status":"ok","timestamp":1692035182981,"user_tz":-120,"elapsed":9401,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"d57f2615-ee2e-47ae-9818-ffc30d3d76fb"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["              Model CV_type  Splits Train&Validation     Parameters  \\\n","0  LinearRegression   mulTs       1   (21030, 21029)  [5, 0.0, 0.0]   \n","1  LinearRegression   mulTs       2   (42059, 21029)  [5, 0.0, 0.0]   \n","2  LinearRegression   mulTs       3   (63088, 21029)  [5, 0.0, 0.0]   \n","3  LinearRegression   mulTs       4   (84117, 21029)  [5, 0.0, 0.0]   \n","4  LinearRegression   mulTs       5  (105146, 21029)  [5, 0.0, 0.0]   \n","\n","          RMSE      MAPE          MAE      Variance        R2  Adjusted_R2  \\\n","0   338.328884  0.022718   169.111114  1.957462e+07  0.993768     0.993767   \n","1   727.038972  0.120319   679.764985  5.727091e+06  0.891042     0.891016   \n","2   669.821163  0.071264   621.032877  2.882406e+06  0.803533     0.803487   \n","3  2402.589061  0.045645  2055.730818  2.343816e+08  0.971661     0.971654   \n","4   786.999088  0.026098   635.377354  9.265717e+07  0.993443     0.993441   \n","\n","       Time  \n","0  0.660874  \n","1  0.633542  \n","2  0.923872  \n","3  1.242934  \n","4  1.415229  "],"text/html":["\n","\n","  <div id=\"df-09eade7b-5af3-4e44-ad49-f075c8c2ceb2\">\n","    <div class=\"colab-df-container\">\n","      <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Model</th>\n","      <th>CV_type</th>\n","      <th>Splits</th>\n","      <th>Train&amp;Validation</th>\n","      <th>Parameters</th>\n","      <th>RMSE</th>\n","      <th>MAPE</th>\n","      <th>MAE</th>\n","      <th>Variance</th>\n","      <th>R2</th>\n","      <th>Adjusted_R2</th>\n","      <th>Time</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>LinearRegression</td>\n","      <td>mulTs</td>\n","      <td>1</td>\n","      <td>(21030, 21029)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>338.328884</td>\n","      <td>0.022718</td>\n","      <td>169.111114</td>\n","      <td>1.957462e+07</td>\n","      <td>0.993768</td>\n","      <td>0.993767</td>\n","      <td>0.660874</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>LinearRegression</td>\n","      <td>mulTs</td>\n","      <td>2</td>\n","      <td>(42059, 21029)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>727.038972</td>\n","      <td>0.120319</td>\n","      <td>679.764985</td>\n","      <td>5.727091e+06</td>\n","      <td>0.891042</td>\n","      <td>0.891016</td>\n","      <td>0.633542</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>LinearRegression</td>\n","      <td>mulTs</td>\n","      <td>3</td>\n","      <td>(63088, 21029)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>669.821163</td>\n","      <td>0.071264</td>\n","      <td>621.032877</td>\n","      <td>2.882406e+06</td>\n","      <td>0.803533</td>\n","      <td>0.803487</td>\n","      <td>0.923872</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>LinearRegression</td>\n","      <td>mulTs</td>\n","      <td>4</td>\n","      <td>(84117, 21029)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>2402.589061</td>\n","      <td>0.045645</td>\n","      <td>2055.730818</td>\n","      <td>2.343816e+08</td>\n","      <td>0.971661</td>\n","      <td>0.971654</td>\n","      <td>1.242934</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>LinearRegression</td>\n","      <td>mulTs</td>\n","      <td>5</td>\n","      <td>(105146, 21029)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>786.999088</td>\n","      <td>0.026098</td>\n","      <td>635.377354</td>\n","      <td>9.265717e+07</td>\n","      <td>0.993443</td>\n","      <td>0.993441</td>\n","      <td>1.415229</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-09eade7b-5af3-4e44-ad49-f075c8c2ceb2')\"\n","              title=\"Convert this dataframe to an interactive table.\"\n","              style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","       width=\"24px\">\n","    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n","    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n","  </svg>\n","      </button>\n","\n","\n","\n","    <div id=\"df-81bd9ffa-a3eb-4559-8870-904c18ab07c0\">\n","      <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-81bd9ffa-a3eb-4559-8870-904c18ab07c0')\"\n","              title=\"Suggest charts.\"\n","              style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","      </button>\n","    </div>\n","\n","<style>\n","  .colab-df-quickchart {\n","    background-color: #E8F0FE;\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: #1967D2;\n","    height: 32px;\n","    padding: 0 0 0 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: #E2EBFA;\n","    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: #174EA6;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","    background-color: #3B4455;\n","    fill: #D2E3FC;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart:hover {\n","    background-color: #434B5C;\n","    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","    fill: #FFFFFF;\n","  }\n","</style>\n","\n","    <script>\n","      async function quickchart(key) {\n","        const containerElement = document.querySelector('#' + key);\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      }\n","    </script>\n","\n","      <script>\n","\n","function displayQuickchartButton(domScope) {\n","  let quickchartButtonEl =\n","    domScope.querySelector('#df-81bd9ffa-a3eb-4559-8870-904c18ab07c0 button.colab-df-quickchart');\n","  quickchartButtonEl.style.display =\n","    google.colab.kernel.accessAllowed ? 'block' : 'none';\n","}\n","\n","        displayQuickchartButton(document);\n","      </script>\n","      <style>\n","    .colab-df-container {\n","      display:flex;\n","      flex-wrap:wrap;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","      <script>\n","        const buttonEl =\n","          document.querySelector('#df-09eade7b-5af3-4e44-ad49-f075c8c2ceb2 button.colab-df-convert');\n","        buttonEl.style.display =\n","          google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","        async function convertToInteractive(key) {\n","          const element = document.querySelector('#df-09eade7b-5af3-4e44-ad49-f075c8c2ceb2');\n","          const dataTable =\n","            await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                     [key], {});\n","          if (!dataTable) return;\n","\n","          const docLinkHtml = 'Like what you see? Visit the ' +\n","            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","            + ' to learn more about interactive tables.';\n","          element.innerHTML = '';\n","          dataTable['output_type'] = 'display_data';\n","          await google.colab.output.renderOutput(dataTable, element);\n","          const docLink = document.createElement('div');\n","          docLink.innerHTML = docLinkHtml;\n","          element.appendChild(docLink);\n","        }\n","      </script>\n","    </div>\n","  </div>\n"]},"metadata":{},"execution_count":27}],"source":["results_mul_cv, trained_models_mul_cv = utilities.tsCrossValidation(df, cm_features, params, mul_cv, MODEL_NAME, FEATURES_LABEL, TARGET_VAL)\n","results_mul_cv"]},{"cell_type":"code","execution_count":28,"metadata":{"id":"FOYB6QaTwew4","colab":{"base_uri":"https://localhost:8080/","height":363},"executionInfo":{"status":"ok","timestamp":1692035197797,"user_tz":-120,"elapsed":12841,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"ef93edc2-8ad4-4cce-e92b-ae69437dd4f0"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["              Model CV_type  Splits Train&Validation     Parameters  \\\n","0  LinearRegression   blkTs       1    (10093, 2524)  [5, 0.0, 0.0]   \n","1  LinearRegression   blkTs       2    (10093, 2524)  [5, 0.0, 0.0]   \n","2  LinearRegression   blkTs       3    (10093, 2524)  [5, 0.0, 0.0]   \n","3  LinearRegression   blkTs       4    (10093, 2524)  [5, 0.0, 0.0]   \n","4  LinearRegression   blkTs       5    (10093, 2524)  [5, 0.0, 0.0]   \n","5  LinearRegression   blkTs       6    (10093, 2524)  [5, 0.0, 0.0]   \n","6  LinearRegression   blkTs       7    (10093, 2524)  [5, 0.0, 0.0]   \n","7  LinearRegression   blkTs       8    (10093, 2524)  [5, 0.0, 0.0]   \n","8  LinearRegression   blkTs       9    (10093, 2524)  [5, 0.0, 0.0]   \n","9  LinearRegression   blkTs      10    (10093, 2524)  [5, 0.0, 0.0]   \n","\n","          RMSE      MAPE          MAE      Variance        R2  Adjusted_R2  \\\n","0    20.440124  0.031359    18.579107  9.264988e+02  0.170188     0.168540   \n","1    56.790467  0.018705    36.436805  2.442916e+05  0.986326     0.986299   \n","2   825.121973  0.072540   705.959905  3.856806e+06  0.867676     0.867413   \n","3   141.380960  0.019697   125.617935  7.307110e+04  0.546363     0.545462   \n","4   285.712596  0.021238   229.631391  9.699016e+05  0.910784     0.910607   \n","5   356.692876  0.035043   240.088297  9.217483e+05  0.842944     0.842632   \n","6   650.534860  0.015494   400.436602  4.797130e+07  0.991333     0.991315   \n","7   887.298211  0.014912   689.115272  5.238469e+06  0.880310     0.880072   \n","8   909.209995  0.023728   678.963174  2.392864e+07  0.964212     0.964141   \n","9  1495.805437  0.049157  1121.344845  3.289154e+06 -1.321536    -1.326146   \n","\n","       Time  \n","0  0.543588  \n","1  0.442911  \n","2  0.493521  \n","3  0.478440  \n","4  0.510443  \n","5  0.467402  \n","6  0.433683  \n","7  0.591652  \n","8  0.848307  \n","9  0.383274  "],"text/html":["\n","\n","  <div id=\"df-4208df37-c90e-4eb7-b9e4-1a38e82ffed6\">\n","    <div class=\"colab-df-container\">\n","      <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Model</th>\n","      <th>CV_type</th>\n","      <th>Splits</th>\n","      <th>Train&amp;Validation</th>\n","      <th>Parameters</th>\n","      <th>RMSE</th>\n","      <th>MAPE</th>\n","      <th>MAE</th>\n","      <th>Variance</th>\n","      <th>R2</th>\n","      <th>Adjusted_R2</th>\n","      <th>Time</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>1</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>20.440124</td>\n","      <td>0.031359</td>\n","      <td>18.579107</td>\n","      <td>9.264988e+02</td>\n","      <td>0.170188</td>\n","      <td>0.168540</td>\n","      <td>0.543588</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>2</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>56.790467</td>\n","      <td>0.018705</td>\n","      <td>36.436805</td>\n","      <td>2.442916e+05</td>\n","      <td>0.986326</td>\n","      <td>0.986299</td>\n","      <td>0.442911</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>3</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>825.121973</td>\n","      <td>0.072540</td>\n","      <td>705.959905</td>\n","      <td>3.856806e+06</td>\n","      <td>0.867676</td>\n","      <td>0.867413</td>\n","      <td>0.493521</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>4</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>141.380960</td>\n","      <td>0.019697</td>\n","      <td>125.617935</td>\n","      <td>7.307110e+04</td>\n","      <td>0.546363</td>\n","      <td>0.545462</td>\n","      <td>0.478440</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>5</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>285.712596</td>\n","      <td>0.021238</td>\n","      <td>229.631391</td>\n","      <td>9.699016e+05</td>\n","      <td>0.910784</td>\n","      <td>0.910607</td>\n","      <td>0.510443</td>\n","    </tr>\n","    <tr>\n","      <th>5</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>6</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>356.692876</td>\n","      <td>0.035043</td>\n","      <td>240.088297</td>\n","      <td>9.217483e+05</td>\n","      <td>0.842944</td>\n","      <td>0.842632</td>\n","      <td>0.467402</td>\n","    </tr>\n","    <tr>\n","      <th>6</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>7</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>650.534860</td>\n","      <td>0.015494</td>\n","      <td>400.436602</td>\n","      <td>4.797130e+07</td>\n","      <td>0.991333</td>\n","      <td>0.991315</td>\n","      <td>0.433683</td>\n","    </tr>\n","    <tr>\n","      <th>7</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>8</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>887.298211</td>\n","      <td>0.014912</td>\n","      <td>689.115272</td>\n","      <td>5.238469e+06</td>\n","      <td>0.880310</td>\n","      <td>0.880072</td>\n","      <td>0.591652</td>\n","    </tr>\n","    <tr>\n","      <th>8</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>9</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>909.209995</td>\n","      <td>0.023728</td>\n","      <td>678.963174</td>\n","      <td>2.392864e+07</td>\n","      <td>0.964212</td>\n","      <td>0.964141</td>\n","      <td>0.848307</td>\n","    </tr>\n","    <tr>\n","      <th>9</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>10</td>\n","      <td>(10093, 2524)</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>1495.805437</td>\n","      <td>0.049157</td>\n","      <td>1121.344845</td>\n","      <td>3.289154e+06</td>\n","      <td>-1.321536</td>\n","      <td>-1.326146</td>\n","      <td>0.383274</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-4208df37-c90e-4eb7-b9e4-1a38e82ffed6')\"\n","              title=\"Convert this dataframe to an interactive table.\"\n","              style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","       width=\"24px\">\n","    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n","    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n","  </svg>\n","      </button>\n","\n","\n","\n","    <div id=\"df-a61baaaa-0743-46cc-8b12-d9bc16cbe0ab\">\n","      <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-a61baaaa-0743-46cc-8b12-d9bc16cbe0ab')\"\n","              title=\"Suggest charts.\"\n","              style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","      </button>\n","    </div>\n","\n","<style>\n","  .colab-df-quickchart {\n","    background-color: #E8F0FE;\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: #1967D2;\n","    height: 32px;\n","    padding: 0 0 0 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: #E2EBFA;\n","    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: #174EA6;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","    background-color: #3B4455;\n","    fill: #D2E3FC;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart:hover {\n","    background-color: #434B5C;\n","    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","    fill: #FFFFFF;\n","  }\n","</style>\n","\n","    <script>\n","      async function quickchart(key) {\n","        const containerElement = document.querySelector('#' + key);\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      }\n","    </script>\n","\n","      <script>\n","\n","function displayQuickchartButton(domScope) {\n","  let quickchartButtonEl =\n","    domScope.querySelector('#df-a61baaaa-0743-46cc-8b12-d9bc16cbe0ab button.colab-df-quickchart');\n","  quickchartButtonEl.style.display =\n","    google.colab.kernel.accessAllowed ? 'block' : 'none';\n","}\n","\n","        displayQuickchartButton(document);\n","      </script>\n","      <style>\n","    .colab-df-container {\n","      display:flex;\n","      flex-wrap:wrap;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","      <script>\n","        const buttonEl =\n","          document.querySelector('#df-4208df37-c90e-4eb7-b9e4-1a38e82ffed6 button.colab-df-convert');\n","        buttonEl.style.display =\n","          google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","        async function convertToInteractive(key) {\n","          const element = document.querySelector('#df-4208df37-c90e-4eb7-b9e4-1a38e82ffed6');\n","          const dataTable =\n","            await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                     [key], {});\n","          if (!dataTable) return;\n","\n","          const docLinkHtml = 'Like what you see? Visit the ' +\n","            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","            + ' to learn more about interactive tables.';\n","          element.innerHTML = '';\n","          dataTable['output_type'] = 'display_data';\n","          await google.colab.output.renderOutput(dataTable, element);\n","          const docLink = document.createElement('div');\n","          docLink.innerHTML = docLinkHtml;\n","          element.appendChild(docLink);\n","        }\n","      </script>\n","    </div>\n","  </div>\n"]},"metadata":{},"execution_count":28}],"source":["results_blk_cv, trained_models_blk_cv = utilities.tsCrossValidation(df, cm_features, params, blk_cv, MODEL_NAME, FEATURES_LABEL, TARGET_VAL)\n","results_blk_cv"]},{"cell_type":"markdown","metadata":{"id":"A2CPzvPu1Hqr"},"source":["# Comparison table"]},{"cell_type":"code","execution_count":29,"metadata":{"id":"XoQKj2kf0vjx","executionInfo":{"status":"ok","timestamp":1692035197799,"user_tz":-120,"elapsed":23,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Define what model_info and evaluators in the Model Comparison Table\n","model_info = ['Model','CV_type','Parameters']\n","evaluator_lst = ['RMSE','MAPE','MAE','Variance','R2','Adjusted_R2','Time']\n","\n","# The the Cross Validation results would like to compare\n","comparison_lst = [results_mul_cv, results_blk_cv]"]},{"cell_type":"code","execution_count":30,"metadata":{"id":"lGoMtK0L0wlh","colab":{"base_uri":"https://localhost:8080/","height":112},"executionInfo":{"status":"ok","timestamp":1692035197799,"user_tz":-120,"elapsed":22,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}},"outputId":"29ae8000-fb2a-418c-bc56-2239004063d6"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["              Model CV_type     Parameters        RMSE      MAPE         MAE  \\\n","0  LinearRegression   mulTs  [5, 0.0, 0.0]  984.955434  0.057209  832.203430   \n","0  LinearRegression   blkTs  [5, 0.0, 0.0]  562.898750  0.030188  424.617333   \n","\n","       Variance        R2  Adjusted_R2      Time  \n","0  7.104457e+07  0.930689     0.930673  0.975290  \n","0  8.649431e+06  0.583860     0.583034  0.519322  "],"text/html":["\n","\n","  <div id=\"df-a2adf2d0-4091-45bf-80e0-64cf892e1bb8\">\n","    <div class=\"colab-df-container\">\n","      <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>Model</th>\n","      <th>CV_type</th>\n","      <th>Parameters</th>\n","      <th>RMSE</th>\n","      <th>MAPE</th>\n","      <th>MAE</th>\n","      <th>Variance</th>\n","      <th>R2</th>\n","      <th>Adjusted_R2</th>\n","      <th>Time</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>LinearRegression</td>\n","      <td>mulTs</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>984.955434</td>\n","      <td>0.057209</td>\n","      <td>832.203430</td>\n","      <td>7.104457e+07</td>\n","      <td>0.930689</td>\n","      <td>0.930673</td>\n","      <td>0.975290</td>\n","    </tr>\n","    <tr>\n","      <th>0</th>\n","      <td>LinearRegression</td>\n","      <td>blkTs</td>\n","      <td>[5, 0.0, 0.0]</td>\n","      <td>562.898750</td>\n","      <td>0.030188</td>\n","      <td>424.617333</td>\n","      <td>8.649431e+06</td>\n","      <td>0.583860</td>\n","      <td>0.583034</td>\n","      <td>0.519322</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-a2adf2d0-4091-45bf-80e0-64cf892e1bb8')\"\n","              title=\"Convert this dataframe to an interactive table.\"\n","              style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","       width=\"24px\">\n","    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n","    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n","  </svg>\n","      </button>\n","\n","\n","\n","    <div id=\"df-d06ee91a-d862-4180-b805-bf373600f35c\">\n","      <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-d06ee91a-d862-4180-b805-bf373600f35c')\"\n","              title=\"Suggest charts.\"\n","              style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","      </button>\n","    </div>\n","\n","<style>\n","  .colab-df-quickchart {\n","    background-color: #E8F0FE;\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: #1967D2;\n","    height: 32px;\n","    padding: 0 0 0 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: #E2EBFA;\n","    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: #174EA6;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","    background-color: #3B4455;\n","    fill: #D2E3FC;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart:hover {\n","    background-color: #434B5C;\n","    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","    fill: #FFFFFF;\n","  }\n","</style>\n","\n","    <script>\n","      async function quickchart(key) {\n","        const containerElement = document.querySelector('#' + key);\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      }\n","    </script>\n","\n","      <script>\n","\n","function displayQuickchartButton(domScope) {\n","  let quickchartButtonEl =\n","    domScope.querySelector('#df-d06ee91a-d862-4180-b805-bf373600f35c button.colab-df-quickchart');\n","  quickchartButtonEl.style.display =\n","    google.colab.kernel.accessAllowed ? 'block' : 'none';\n","}\n","\n","        displayQuickchartButton(document);\n","      </script>\n","      <style>\n","    .colab-df-container {\n","      display:flex;\n","      flex-wrap:wrap;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","      <script>\n","        const buttonEl =\n","          document.querySelector('#df-a2adf2d0-4091-45bf-80e0-64cf892e1bb8 button.colab-df-convert');\n","        buttonEl.style.display =\n","          google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","        async function convertToInteractive(key) {\n","          const element = document.querySelector('#df-a2adf2d0-4091-45bf-80e0-64cf892e1bb8');\n","          const dataTable =\n","            await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                     [key], {});\n","          if (!dataTable) return;\n","\n","          const docLinkHtml = 'Like what you see? Visit the ' +\n","            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","            + ' to learn more about interactive tables.';\n","          element.innerHTML = '';\n","          dataTable['output_type'] = 'display_data';\n","          await google.colab.output.renderOutput(dataTable, element);\n","          const docLink = document.createElement('div');\n","          docLink.innerHTML = docLinkHtml;\n","          element.appendChild(docLink);\n","        }\n","      </script>\n","    </div>\n","  </div>\n"]},"metadata":{},"execution_count":30}],"source":["# Show the Comparison Table\n","pd.concat([utilities.modelComparison(cv_result, model_info, evaluator_lst) for cv_result in comparison_lst])"]},{"cell_type":"markdown","source":["# Training the final model"],"metadata":{"id":"17W_IjDp1A4C"}},{"cell_type":"code","source":["model = utilities.train_final_model(df, cm_features, params, MODEL_NAME, FEATURES_LABEL, TARGET_VAL)"],"metadata":{"id":"n-eaEIC08all","executionInfo":{"status":"ok","timestamp":1692035198606,"user_tz":-120,"elapsed":825,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"execution_count":31,"outputs":[]},{"cell_type":"code","execution_count":32,"metadata":{"id":"-3xfXIbR--Jz","executionInfo":{"status":"ok","timestamp":1692035198607,"user_tz":-120,"elapsed":10,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["GDRIVE_MODELS_DIR = GDRIVE_DIR + \"/MyDrive/BDC/project/models\"\n","GDRIVE_MODEL_NAME_EXT = GDRIVE_MODELS_DIR + \"/\" + MODEL_NAME"]},{"cell_type":"code","execution_count":33,"metadata":{"id":"G1cdiK9R_BVW","executionInfo":{"status":"ok","timestamp":1692035199188,"user_tz":-120,"elapsed":589,"user":{"displayName":"Pinco Pallino","userId":"00511828708821930945"}}},"outputs":[],"source":["# Save the trained model\n","model.write().overwrite().save(GDRIVE_MODEL_NAME_EXT)"]}],"metadata":{"accelerator":"GPU","colab":{"gpuType":"T4","provenance":[{"file_id":"1GT6j85hVq7UE2X4fwgflfXS7JNTV-kqo","timestamp":1692032844762},{"file_id":"1sHk3xymRpuhT-ed55fgJvYEXhNEUCS2r","timestamp":1692032606904},{"file_id":"1Sy-3mom83C7tT6qe2ni8uDj1OKHJVULj","timestamp":1692032307277},{"file_id":"11F5bwP08Ep7Y8VjZPrbVEmzpngDr3nEJ","timestamp":1691764684191},{"file_id":"1lg_X0P096b94i0oHy3o3UI_tycwaqlAg","timestamp":1686125902527}],"toc_visible":true},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.9.13"},"vscode":{"interpreter":{"hash":"303fa613b6f3e1efefe7bb28036e305e1021fa6bdb083a5f9fd57f9d9bbad8eb"}}},"nbformat":4,"nbformat_minor":0}